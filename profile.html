<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile â€“ Docterbee Member</title>

    <!-- External Stylesheets -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/card-preview.css" />
    <style>
      .profile-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
        border: 3px solid rgba(255, 255, 255, 0.3);
      }

      .profile-info-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .info-row {
        display: flex;
        padding: 1rem 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #64748b;
        min-width: 140px;
      }

      .info-value {
        color: #1f2937;
        flex: 1;
      }

      @media (max-width: 768px) {
        .profile-container {
          padding: 1rem;
        }

        .profile-header {
          padding: 1.5rem;
        }

        .profile-info-card {
          padding: 1.5rem;
        }

        .info-row {
          flex-direction: column;
          gap: 0.5rem;
        }

        .info-label {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-slate-900">
    <!-- Header Navigation -->
    <header
      class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-gray-200"
    >
      <div
        class="mx-auto max-w-6xl px-4 h-16 flex items-center justify-between"
      >
        <a href="/" class="flex items-center gap-2">
          <div class="logo-box"></div>
          <span class="font-semibold">Docterbee</span>
        </a>
        <nav class="hidden md:flex gap-6 text-sm">
          <a href="/" id="guestNavItem" class="nav-link">Beranda</a>
          <a href="/journey" class="nav-link">Journey</a>
          <a href="/services" class="nav-link">Services</a>
          <a href="/store" class="nav-link">Store</a>
          <a href="/events" class="nav-link">Events</a>
          <a href="/insight" class="nav-link">Insight</a>
          <a href="/media" class="nav-link">Media</a>
          <a href="/ai-advisor" class="nav-link">AI Advisor</a>
        </nav>
        <div class="flex items-center gap-3">
          <span class="points-display" id="pointsDisplay" style="display: none;"> Points: <b id="pointsValue">0</b> </span>
          <a href="/profile" id="profileBtn" class="nav-link active" style="display: none;" title="Profile">
            <i data-lucide="user" class="w-5 h-5"></i>
          </a>
          <button
            id="logoutBtn"
            class="hidden md:block text-sm text-red-600 hover:text-red-700 font-semibold"
            aria-label="Logout"
            style="display: none;"
          >
            Logout
          </button>
          <button
            id="hamburgerBtn"
            class="md:hidden hamburger-btn"
            aria-label="Toggle menu"
          >
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay hidden"></div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
      <div class="mobile-menu-header">
        <span class="font-semibold">Menu</span>
        <button
          id="closeMobileMenu"
          class="close-menu-btn"
          aria-label="Close menu"
        >
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="mobile-menu-nav">
        <a href="/" id="mobileGuestNavItem" class="mobile-nav-link">Beranda</a>
        <a href="/journey" class="mobile-nav-link">Journey</a>
        <a href="/services" class="mobile-nav-link">Services</a>
        <a href="/store" class="mobile-nav-link">Store</a>
        <a href="/booking" class="mobile-nav-link">Booking</a>
        <a href="/events" class="mobile-nav-link">Events</a>
        <a href="/insight" class="mobile-nav-link">Insight</a>
        <a href="/media" class="mobile-nav-link">Media</a>
        <a href="/ai-advisor" class="mobile-nav-link">AI Advisor</a>
      </nav>
      <div class="mobile-menu-footer">
        <span class="points-display" id="mobilePointsDisplay" style="display: none;">
          Points: <b id="mobileNavPoints">0</b>
        </span>
        <a href="/profile" id="mobileProfileBtn" class="mobile-nav-link" style="display: none;">
          <i data-lucide="user" class="w-5 h-5 inline mr-2"></i>
          Profile
        </a>
        <button
          id="mobileLogoutBtn"
          class="hidden mt-4 w-full py-2 px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors"
          style="display: none;"
        >
          Logout
        </button>
        <a
          id="mobileLoginBtn"
          href="/login"
          class="hidden mt-4 w-full py-2 px-4 bg-amber-400 hover:bg-amber-500 text-slate-900 font-semibold rounded-lg transition-colors text-center block"
        >
          Login
        </a>
      </div>
    </div>

    <!-- Profile Content -->
    <main class="profile-container">
      <!-- Loading State -->
      <div id="loadingState" style="text-align: center; padding: 3rem;">
        <p class="text-slate-600">Memuat data profile...</p>
      </div>

      <!-- Profile Content (Hidden initially) -->
      <div id="profileContent" style="display: none;">
        <!-- Profile Header -->
        <div class="profile-header">
          <div class="profile-avatar" id="profileAvatar">U</div>
          <h1 class="text-2xl font-bold mb-1" id="profileName">Loading...</h1>
          <p class="opacity-90" id="profileEmail">loading@example.com</p>
        </div>

        <!-- Profile Information -->
        <div class="profile-info-card">
          <h2 class="text-xl font-bold mb-4">Informasi Akun</h2>
          <div class="info-row">
            <div class="info-label">Nama Lengkap</div>
            <div class="info-value" id="infoName">-</div>
          </div>
          <div class="info-row">
            <div class="info-label">Email</div>
            <div class="info-value" id="infoEmail">-</div>
          </div>
          <div class="info-row">
            <div class="info-label">Nomor Telepon</div>
            <div class="info-value" id="infoPhone">-</div>
          </div>
          <div class="info-row">
            <div class="info-label">Jenis Kartu</div>
            <div class="info-value" id="infoCardType">-</div>
          </div>
          <div class="info-row">
            <div class="info-label">Points</div>
            <div class="info-value" id="infoPoints">0 Points</div>
          </div>
        </div>

        <!-- Membership Card -->
        <div class="profile-info-card">
          <h2 class="text-xl font-bold mb-4">Kartu Member Anda</h2>
          <div class="card-preview-container" style="display: block;">
            <div class="card-flip-wrapper" id="profileCardFlipWrapper">
              <!-- Front Face -->
              <div class="card-face card-face-front">
                <img id="profileCardFrontImage" src="" alt="Card Front" class="card-image" />
                <div class="card-overlay">
                  <div class="card-info" id="profileCardInfo">
                    <div class="card-name" id="profileCardNameDisplay">Nama Anda</div>
                    <div class="card-phone" id="profileCardPhoneDisplay">08xxxxxxxxxx</div>
                    <div class="card-points" id="profileCardPointsDisplay">0 Points</div>
                  </div>
                </div>
              </div>
              <!-- Back Face -->
              <div class="card-face card-face-back">
                <img id="profileCardBackImage" src="" alt="Card Back" class="card-image" />
              </div>
            </div>
            <div class="card-flip-hint">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Klik kartu untuk melihat bagian belakang
            </div>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="errorState" style="display: none; text-align: center; padding: 3rem;">
        <p class="text-red-600 mb-4">Gagal memuat data profile. Silakan login terlebih dahulu.</p>
        <button onclick="window.location.href='/login'" class="btn btn-primary">
          Login
        </button>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      lucide.createIcons();
    </script>
    <script src="js/script.js"></script>
    <script src="js/app-navbar.js"></script>

    <!-- Profile Logic -->
    <script>
      // Card type mapping (same as register page)
      const cardTypeMapping = {
        'Active-Worker': {
          front: '/uploads/gambar_kartu/depan/Background-Active-Worker.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-Active-Worker.png',
          label: 'Active Worker'
        },
        'Family-Member': {
          front: '/uploads/gambar_kartu/depan/Background-Family-Member.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-Family-Member.png',
          label: 'Family Member'
        },
        'Healthy-Smart-Kids': {
          front: '/uploads/gambar_kartu/depan/Background-Healthy-&-Smart-Kids.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-Healthy-&-Smart-Kids.png',
          label: 'Healthy & Smart Kids'
        },
        'Mums-Baby': {
          front: '/uploads/gambar_kartu/depan/Background-Mums-&-Baby.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-Mums-&-Baby.png',
          label: 'Mums & Baby'
        },
        'New-Couple': {
          front: '/uploads/gambar_kartu/depan/Background-New-Couple.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-New-Couple.png',
          label: 'New Couple'
        },
        'Pregnant-Preparation': {
          front: '/uploads/gambar_kartu/depan/Background-Pregnant-Preparatiom.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-Pregnant-Preparatiom.png',
          label: 'Pregnant Preparation'
        },
        'Senja-Ceria': {
          front: '/uploads/gambar_kartu/depan/Background-Senja-Ceria.png',
          back: '/uploads/gambar_kartu/belakang/Tampilan-Belakang-Senja-Ceria.png',
          label: 'Senja Ceria'
        }
      };

      // Flip card on click
      const profileCardFlipWrapper = document.getElementById('profileCardFlipWrapper');
      profileCardFlipWrapper.addEventListener('click', function() {
        this.classList.toggle('flipped');
      });

      // Load profile data
      async function loadProfileData() {
        try {
          // Get user data
          const response = await fetch('/api/auth/me', {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Not authenticated');
          }

          const result = await response.json();
          
          if (!result.success || !result.data) {
            throw new Error('Failed to load profile');
          }

          const user = result.data;

          // Get points data
          let points = 0;
          try {
            const progressResponse = await fetch('/api/user-data/progress', {
              credentials: 'include'
            });
            if (progressResponse.ok) {
              const progressData = await progressResponse.json();
              if (progressData.success && progressData.data) {
                points = progressData.data.points || 0;
              }
            }
          } catch (e) {
            console.log('Could not load points:', e);
          }

          // Update UI
          displayProfileData(user, points);

          // Hide loading, show content
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('profileContent').style.display = 'block';

        } catch (error) {
          console.error('Error loading profile:', error);
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('errorState').style.display = 'block';
        }
      }

      function displayProfileData(user, points) {
        // Get first letter for avatar
        const firstLetter = user.name.charAt(0).toUpperCase();
        
        // Update header
        document.getElementById('profileAvatar').textContent = firstLetter;
        document.getElementById('profileName').textContent = user.name;
        document.getElementById('profileEmail').textContent = user.email;

        // Update info rows
        document.getElementById('infoName').textContent = user.name;
        document.getElementById('infoEmail').textContent = user.email;
        document.getElementById('infoPhone').textContent = user.phone;
        
        // Update card type
        const cardType = user.card_type || 'Active-Worker';
        const cardData = cardTypeMapping[cardType];
        
        if (cardData) {
          document.getElementById('infoCardType').textContent = cardData.label;
          
          // Update card preview
          document.getElementById('profileCardFrontImage').src = cardData.front;
          document.getElementById('profileCardBackImage').src = cardData.back;
          document.getElementById('profileCardNameDisplay').textContent = user.name;
          document.getElementById('profileCardPhoneDisplay').textContent = user.phone;
          document.getElementById('profileCardPointsDisplay').textContent = `${points} Points`;
          
          // Apply smaller font and lower position for specific card types
          const smallNameTypes = ['Mums-Baby', 'New-Couple', 'Pregnant-Preparation'];
          const nameElement = document.getElementById('profileCardNameDisplay');
          const infoElement = document.getElementById('profileCardInfo');
          if (smallNameTypes.includes(cardType)) {
            nameElement.classList.add('card-name-small');
            if (infoElement) infoElement.classList.add('card-info-lower');
          } else {
            nameElement.classList.remove('card-name-small');
            if (infoElement) infoElement.classList.remove('card-info-lower');
          }
        }

        // Update points
        document.getElementById('infoPoints').textContent = `${points} Points`;
        
        // Update navbar points (desktop and mobile)
        const pointsDisplay = document.getElementById('pointsDisplay');
        const pointsValue = document.getElementById('pointsValue');
        if (pointsDisplay && pointsValue) {
          pointsValue.textContent = points;
          pointsDisplay.style.display = 'block';
        }

        const mobilePointsDisplay = document.getElementById('mobilePointsDisplay');
        const mobileNavPoints = document.getElementById('mobileNavPoints');
        if (mobilePointsDisplay && mobileNavPoints) {
          mobileNavPoints.textContent = points;
          mobilePointsDisplay.style.display = 'block';
        }

        // Show profile and logout buttons
        const profileBtn = document.getElementById('profileBtn');
        const mobileProfileBtn = document.getElementById('mobileProfileBtn');
        if (profileBtn) profileBtn.style.display = 'block';
        if (mobileProfileBtn) mobileProfileBtn.style.display = 'block';
      }

      // Logout functionality (using handleLogout from script.js)
      const logoutBtn = document.getElementById('logoutBtn');
      const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');

      if (logoutBtn) {
        logoutBtn.style.display = 'block';
        if (typeof handleLogout === 'function') {
          logoutBtn.addEventListener('click', handleLogout);
        }
      }

      if (mobileLogoutBtn) {
        mobileLogoutBtn.style.display = 'block';
        if (typeof handleLogout === 'function') {
          mobileLogoutBtn.addEventListener('click', handleLogout);
        }
      }

      // Load data on page load
      loadProfileData();
    </script>
  </body>
</html>
